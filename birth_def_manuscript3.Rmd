---
title: "birth_defects_manuscript3"
author: "Taiba"
date: "2024-07-23"
output: pdf_document
---
### Loading and processing pesticide data
```{r}
library(pacman)
pacman::p_load(tidyverse, janitor,reshape2)
```

# 1 Loading original conus data 1992-2019
```{r}

load("~/Desktop/Jabbeen/jt_dissert/jt_dissert/pest_conus_v2.RDA")
dat_conus$year<- as.numeric(as.character(dat_conus$year))
```

# Step 1 Filtering pesticides for NE from 1992- 2014 has 205956 obs and 6 variables
```{r}
dat_ne <- dat_conus |>
  filter(state_fips_code == "31" & year %in% c(1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
                                               2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009,
                                               2010, 2011, 2012, 2013, 2014))

  save(dat_ne, file = "pest_ne_v1.RDA")
```

# Step 2 creating variables median, temporal and spatial variables using original dataset 03/30/23
```{r}
load("pest_ne_v1.RDA")
#median quantity and temporal coverage of chemicals applied
median_pest <- dat_ne %>%
  group_by(county_fips_code, compound) %>%
  summarize(median_pest = median(pest_applied, na.rm = TRUE),
            n_yrs_repeat = sum(!is.na(pest_applied)),
            years = list(unique(year[!is.na(pest_applied)])))|>
  mutate(pct_yrs= round((n_yrs_repeat/23)*100, 2))


#spatial coverage using counties (percent counties with any compound applied per year)
county_cover <- median_pest %>%
  group_by(compound) %>%
  summarize(county_cvr = n_distinct(county_fips_code[!is.na(median_pest)])) |>
  mutate(pct_county_cvr = round((county_cvr/93)*100, 2))

#join median_pest and county-cover
dat_med_cnty_cvr<- left_join(median_pest, county_cover, by=c("compound"))

#########################################################################

# Final data set that has median pesticide applied, pct spatial and temporal coverage has 18730 obs and 8 variables

chem_appl<- dat_med_cnty_cvr |>
  mutate(years = gsub("(^c\\(|\\)$)", "", years))

# save same file in rda format as backup
save(chem_appl, file = "ne_chem_appl_spat_temp_cvr_v2.RDA")
```

#Step 3 chemical selection function
```{r}
compound_filter <- function(data, pct_yrs_thresh, pct_cnty_cvr_thresh) {
  
  # Filter the data based on pct_yrs threshold
  data <- data %>% group_by(compound) %>% filter(mean(pct_yrs) >= pct_yrs_thresh)
  
  # Filter the data based on pct_cnty_cvr threshold
  data <- data %>% group_by(compound) %>% filter(mean(pct_county_cvr) >= pct_cnty_cvr_thresh)
  
  # Return unique list of compounds that match the criteria as a dataframe
  unique(data$compound) %>% as.data.frame()
}
```

# Different percentages generate different lists
```{r}
#Use file: load("ne_chem_appl_spat_temp_cvr_v2.RDA")
compound_filter<- compound_filter(chem_appl,90,100)
compound_filter<- compound_filter |> rename(compound = ".")
write_csv(compound_filter, "ne_chemical_list90_100.csv")

```


# Step 4 Creating a final subset of dataset with selected chemicals 
```{r}
# read in the dataset
load("ne_chem_appl_spat_temp_cvr_v2.RDA")

# Filter chem_appl based on the values in compound_filter
chem_appl_filtered <- chem_appl %>%
  filter(compound %in% compound_filter$compound)

# Summarize pct_yrs by compound
summary <- chem_appl_filtered %>%
  group_by(compound) %>%
  summarize(
    mean_pct_yrs = mean(pct_county_cvr),
    median_pct_yrs = median(pct_county_cvr),
    max_pct_yrs = max(pct_county_cvr),
    min_pct_yrs = min(pct_county_cvr),
    n = n()
  )

save(chem_appl_filtered, file="ne_chem_appl_filtered_v3.RDA")
```

# Step 5 Grouping the pesticides by class and creating final dataset has 2976 obs and 9 variables
```{r}

# create a named vector of compound classes
compound_classes <-list(Herbicide = c("2,4-D", "ATRAZINE","ALACHLOR","ACETOCHLOR","BROMOXYNIL", "CLETHODIM","CLOPYRALID", "DICAMBA","DIMETHENAMID","FLUMETSULAM","GLYPHOSATE", 
                                      "IMAZETHAPYR","MCPA","METOLACHLOR","PARAQUAT", 
                                      "METRIBUZIN","METSULFURON", "NICOSULFURON", "PICLORAM","PENDIMETHALIN","QUIZALOFOP", "SETHOXYDIM", "THIFENSULFURON","TRIASULFURON", "TRIFLURALIN"),
                        
                        Insecticide = c( "BIFENTHRIN" ,"CHLORPYRIFOS", "DIMETHOATE", "ESFENVALERATE","PERMETHRIN","TEFLUTHRIN","TERBUFOS"))

# Create a new variable "class" in chem_appl_filtered
chemi_class <- chem_appl_filtered %>% 
  mutate(class = case_when(
    compound %in% compound_classes[["Herbicide"]] ~ "Herbicide",
    compound %in% compound_classes[["Insecticide"]] ~ "Insecticide",
    TRUE ~ NA_character_
  ))

# Convert "class" variable to factor
chemi_class$class <- as.factor(chemi_class$class)

# Print the first few rows of the resulting dataset
head(chemi_class)

write_csv(chemi_class, "ne_final_chemv4.csv")

# save same file in rda format as backup
save(chemi_class, file = "ne_final_chem_v4_backup.RDA")

```


# Step 6 boxplots for each chemical
```{r}
load("ne_final_chem_v4_backup.RDA")

ggplot(chemi_class, aes(y = compound, x = log(median_pest))) +
  geom_boxplot() +
  labs(title = "",
       x = "Median pesticide applied (1992 - 2014) - Log scale", 
       y = "") +
  facet_grid(factor(class, levels=c("Herbicide", "Insecticide"))~ ., scales = "free_y", 
             switch = "y", space = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 10.5),
        axis.text.y = element_text(size = 10.5),
        strip.text = element_text(colour = "black", size = 10.5),
        strip.text.x = element_text(colour = "black", size = 10.5),
        strip.text.y = element_text(colour = "black", size = 7))


ggsave("ne_chemical_box_plt.tiff", 
       width = 6,height = 9,
       dpi=300)
```

#Step 7 correlation matrix
```{r}
# pivot from long to wide format
chemi_class_wide <- chemi_class[c(1:3)] %>%
  pivot_wider(names_from = compound, values_from = median_pest)|>
   mutate_at(vars(2:33), ~log10(.+0.0000001)) 

write_csv(chemi_class_wide, "ne_final_chem_widev5.csv")

# save same file in rda format as backup
save(chemi_class_wide, file = "ne_final_chem_wide_v5_backup.RDA")
```


```{r}
desired_order <- c("2,4-D", "Acetochlor", "Alachlor", "Atrazine", "Bromoxynil", 
                   "Clethodim", "Clopyralid", "Dicamba", "Dimethenamid",
                   "Flumetsulam", "Glyphosate", "Imazethapyr", "Mcpa",
                   "Metolachlor", 
                   "Metribuzin", "Metsulfuron", "Nicosulfuron", "Paraquat", "Pendimethalin",
                   "Picloram", "Quizalofop", "Sethoxydim",
                   "Thifensulfuron", 
                   "Triasulfuron", "Trifluralin",
                   "Bifenthrin", "Chlorpyrifos", "Dimethoate", "Esfenvalerate", "Permethrin", 
                   "Tefluthrin", "Terbufos")

chemi_class_wide <- read_csv("ne_final_chem_widev5.csv") |>
  rename_all(~str_to_title(.))
  
#correlation matrix
cormat<- round(x=cor(chemi_class_wide[c(2:33)], method = "spearman", 
                     use= "complete.obs"), digits=2) |>
  melt() |>
  mutate_at(vars(Var1, Var2), ~factor(., levels = rev(desired_order)))


ggplot(cormat, aes(x=Var2, y=rev(Var1), fill=value)) +
  geom_tile(color="white")+
  scale_fill_gradient2(low="red", high="blue", mid="white",
                       midpoint=0,
                       limit=c(-1,1), space= "Lab",
                       name="Spearman Correlation | Pesticides applied in NE Counties (1992-2014)")+
  geom_text(aes(label = round(value, 2)), size = 3, color = "black") + # Add text labels
  theme_minimal()+
  geom_hline(yintercept = 7.5, linetype = "dashed", color = "black", size=1.5)+
  geom_vline(xintercept = 7.5, linetype = "dashed", color = "black", size=1.5)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
        axis.text.y = element_text(angle = 0, vjust = 1, size = 12, hjust = 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "bottom", legend.box = "horizontal")+
  coord_fixed()

ggsave("ne_chemical_correlations.tiff",
       width=12, height= 10, dpi=300)
```

####################################################################################################################################
##################################################################################################################################
#Pesticide PCA Analysis

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor, tidymodels, factoextra, ggfortify, gridExtra, knitr, tmap, sp, sf, tigris, spdep)
```

```{r}
ne_chemi_class <- read_csv("ne_final_chemv4.csv") |>
  filter(compound != "TRIASULFURON" & compound != "METSULFURON" & compound != "MCPA" )
```


```{r}
# pivot from long to wide format contains 93 obs with 29 variables
ne_chemi_wide <- ne_chemi_class[c(1:3)] |>
  pivot_wider(names_from = compound, values_from = median_pest) |>
  select(-c(county_fips_code))|>
 mutate_at(vars(1:29), ~log10(.+0.0000001))

# Calculate principal components
#scale: a logical value indicating whether the variables should be scaled to have unit variance before the analysis takes place
pca.ln <- prcomp(ne_chemi_wide, scale = TRUE)
#save(pca.ln, file = "ne_pca_ln.rda")
```

```{r}
#load model object
load("ne_pca_ln.rda")
```

```{r}
eigenvalues_ln <- matrix(pca.ln$sdev^2) #eigenvalues
perc_variance <- round(100*matrix(pca.ln$sdev^2/sum(pca.ln$sdev^2)),1) #variance

#Summary table 
eigenvalues_ln <- cbind(1:29, eigenvalues_ln, perc_variance) 
colum_ln <- c("Principal Component", "Eigenvalues", "Percent Variance")
eigenvalues_ln <- kable(eigenvalues_ln, col.names = colum_ln)
eigenvalues_ln 
```

## Proportion of Variance Plots
The first two components explained 87% of the variance 
```{r PVE plots}
#Plots the proportion of variance explained by each component (scree plot)
pve.ln <- pca.ln$sdev^2/sum(pca.ln$sdev^2) #proportion of variance explain by each component
 
#log-transformed data
fviz_eig(pca.ln, main = "",
         xlab = "Principal component",
         ylim = c(0,50))

ggsave("ne_pca_screeplot.tiff",
       width=6, height= 6, dpi=300)
```


## Data Visualization of eigenvectors w/ Log-Transformed PCA Results
Loadings are the weights that each chemical contribute to the component. Scores are the sum of loadings multiply by concentration of each chemical for each person. So you get a loading for each chemical in each component and also a total loading for each principal component (which is the sum of the chemical's loadings). You also get a score for each person (each observation) which is the sum of the scores of each chemical (loading*chemical concentration). So for each person (observation) you have a score for each principal component. Each principal component also has a score which is the sum of the scores within the principal component. 

```{r}
pca.ln.ld <- as.data.frame.matrix(pca.ln$rotation) ## rotation is the loadings variable within the pca output.
pca.ln.ld$chem <- row.names(pca.ln.ld)

#run compounds_classes from file 02.1_nebraska_pest_analysis.Rmd
# Convert the list to a tibble and unnest the list
loadings_pca <- pca.ln.ld |>
  mutate(Group = case_when(
    chem %in% unlist(compound_classes) & chem %in% compound_classes$Herbicide ~ "Herbicide",
    chem %in% unlist(compound_classes) & chem %in% compound_classes$Insecticide ~ "Insecticide",
    TRUE ~ NA_character_
  ))

plot_loadings_pca <- loadings_pca |> 
  gather(key = "PC", value = "Loading", -chem, -Group) |> as_tibble()

################################################################
chem_order <- c("2,4-D", "ATRAZINE","ALACHLOR","ACETOCHLOR","BROMOXYNIL", "CLETHODIM","CLOPYRALID", "DICAMBA","DIMETHENAMID","FLUMETSULAM","GLYPHOSATE", 
                                      "IMAZETHAPYR","METOLACHLOR","PARAQUAT", 
                                      "METRIBUZIN", "NICOSULFURON", "PICLORAM","PENDIMETHALIN","QUIZALOFOP", "SETHOXYDIM", "THIFENSULFURON", "TRIFLURALIN","BIFENTHRIN" ,"CHLORPYRIFOS", "DIMETHOATE", "ESFENVALERATE","PERMETHRIN","TEFLUTHRIN","TERBUFOS")

plot_loadings_pca |> 
  filter(PC %in% c("PC1", "PC2", "PC3")) |> 
  mutate(PC = as.factor(PC),
         PC = fct_recode(PC, "PC 1" = "PC1",
         "PC 2" = "PC2",
         "PC 3" = "PC3"),
         chem = factor(chem, levels = chem_order)) |> 
  ggplot(aes(x = chem, 
             y = Loading, 
             fill=Group)) + 
  geom_col() +
  facet_wrap(~ PC) + 
  theme_bw() + 
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 90, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  geom_hline(yintercept = 0, linewidth = 0.2) +
  labs(x = "Chemicals",
       y = "Loadings")

ggsave("ne_pca_loadings.tiff",
       width=10, height= 7, dpi=300)
```

#Extracting the first principal component with highest variance for mapping
```{r}
new_index_withpc1<- data.frame(pca.ln$x[,1])

# saving pc1 
#write_csv(new_index_withpc1, "ne_index_scores.csv")
```

#combine index variables with chemicals applied data
```{r}
ne_chem_mapping <- ne_chemi_class[c(1:3)] |>
  pivot_wider(names_from = compound, values_from = median_pest)|>
  mutate_at(vars(2:30), ~log10(.+0.0000001))

# final file for mapping
ne_dat_map<- cbind(ne_chem_mapping, new_index_withpc1)
write_csv(ne_dat_map, "ne_mapping_dat_final.csv")

```

##########################################################################################
############################################################################################
# Spatial analysis
```{r}
ne_counties <- counties(state = "ne", cb = FALSE, resolution = "500k", year = "2010", class="sf") |>
  clean_names()
```


```{r}
dat<- read_csv("ne_mapping_dat_final.csv") |>
  rename(countyfp10="county_fips_code", pc1= "pca.ln.x...1.") |>
  mutate(countyfp10 = str_pad(as.character(countyfp10), width = 3, pad = "0"),
         pc1= pc1*(-1)) #09/07/2023

dat_fin<- left_join(ne_counties, dat, by="countyfp10")
```

#Producing maps
```{r}
# Load the viridis package
library(viridis)
library(tmap)

# Define a custom color palette with Viridis shades
num_colors <- 4  # Set the number of colors in the palette
custom_palette <- viridis(num_colors)

chem<- "pc1"

# Modify your code to use the custom color palette
w <- tm_shape(dat_fin) +
  tm_polygons(col = chem,
              breaks = quantile(dat_fin[[chem]], probs = c(0, .25, .5, .75, 1), na.rm = T),
              legend.is.portrait = FALSE,
              palette = custom_palette,  # Using the custom Viridis color palette
              title = "pc1") +
  tm_borders("gray90", alpha = 0.002) +
  tm_text(text = "name10") +
  tm_layout(legend.title.size = 0.8, legend.text.size = 0.6) +
  tm_legend(position = c("left", "bottom"), frame = TRUE, stack = "vertical") +
  tm_compass(position = c("right", "top")) 

tmap_save(w, "ne_pc1_viridis_palette.tiff",
          width = 12, height = 15, dpi = 150)

```

# Exploratory spatial data analysis (ESDA) - to perform this we are converting neighbors list object to spatial weights
#spatial correlation- understanding spatial neighborhoods using poly2nb() and generating the spatial weights matrix using nb2listw() and specifying style ="B" produces binary weights, where neighbors are given the weight 1 and non-neighbors take the weight of 0. This style of weights is useful for producing neighborhood sums.

# understanding spatial neighborhoods/ contiguity-based neighbors, used when geographic features are polygons. poly2nb(), is used for queen’s case neighbors, where all polygons that share at least one vertex are considered neighbors. This function take an sf object as an argument and produce a neighbors list object
```{r}
neighbors <- poly2nb(col_sp, queen = TRUE)

summary(neighbors)
```

# Summary interpretation- On average, the counties in the CONUS area have 5.93 neighbors. The minimum number of neighbors in the dataset is 1 (there are 13 such tracts), and the maximum number of neighbors is 14 (the tract at row index 2697)

# Calculating spatial weights
```{r}
col_sp <- as(dat_fin, "Spatial")
col_nb <- poly2nb(col_sp) 
col_listw <- nb2listw(col_nb, style = "B") # listw version of the neighborhood

```

# Spatial autocorrelation: The concept of spatial autocorrelation relates to Waldo Tobler’s famous “first law of geography,” which reads (Tobler 1970): Everything is related to everything else, but near things are more related than distant things.
#spatial clustering- data values tend to be similar to neighboring data values

# Global spatial autocorrelation using Moron's I using spdep package. It gives the relationship between observations and their neighbors 

```{r}
moran.test(dat_fin$pc1, listw = col_listw)
```

# Identifying clusters and spatial outliers with local indicators of spatial association (LISA), an extension of Global Moran's I statistic using localmoran_perm() function, implements LISA where statistical significance is calculated based on a conditional permutation-based approach. 

```{r}
set.seed(1983) #random number seed is set given that we are using the conditional permutation approach to calculating statistical significance

dat_fin$scaled_pc1 <- as.numeric(scale(dat_fin$pc1)) #pc1 is converted to a z-score using scale(), which subtracts the mean from the estimate then divides by its standard deviation. This follows convention from GeoDa

# LISA is computed with localmoran_perm() for the scaled value for pc1, using the contiguity-based spatial weights matrix. 999 conditional permutation simulations are used to calculate statistical significance, and the argument alternative = "two.sided" will identify both statistically significant clusters and statistically significant spatial outliers
dfw_lisa <- localmoran_perm( 
 dat_fin$scaled_pc1, 
listw = col_listw, 
  nsim = 999L, 
  alternative = "two.sided"
) %>%
  as_tibble() %>%
  set_names(c("local_i", "exp_i", "var_i", "z_i", "p_i",
              "p_i_sim", "pi_sim_folded", "skewness", "kurtosis"))

# attaching LISA data frame to the Census tract shapes after computing the lagged value for pc1. #spatial lag calculated using lag.listw(), it refers to the neighboring values of an observation given a spatial weights matrix

dfw_lisa_df <- dat_fin %>%
  select(geoid10, scaled_pc1) %>%
  mutate(lagged_estimate = lag.listw(col_listw, scaled_pc1)) %>% 
  bind_cols(dfw_lisa)

#recode the data into appropriate categories for the LISA quadrant plot, using a significance level of p = 0.05

dfw_lisa_clusters <- dfw_lisa_df %>% 
  mutate(lisa_cluster = case_when(
    p_i >= 0.05 ~ "Not significant",
    scaled_pc1 > 0 & local_i > 0 ~ "High-high",
    scaled_pc1 > 0 & local_i < 0 ~ "High-low",
    scaled_pc1 < 0 & local_i > 0 ~ "Low-low",
    scaled_pc1 < 0 & local_i < 0 ~ "Low-high"
  ))

#The LISA quadrant plot

color_values <- c(`High-high` = "Yellow", 
                  `High-low` = "pink", 
                  `Low-low` = "purple", 
                  `Low-high` = "lightblue", 
                  `Not significant` = "white")

ggplot(dfw_lisa_clusters, aes(x = scaled_pc1, 
                              y = lagged_estimate,
                              fill = lisa_cluster)) + 
  geom_point(color = "black", shape = 21, size = 2) + 
  theme_minimal() + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  scale_fill_manual(values = color_values) + 
  labs(x = "PC 1 (z-score)",
       y = "Spatial lag of PC 1 (z-score)",
       fill = "Cluster type")

ggsave("ne_pc1_lisa_clusters.tiff",
          width = 12, height=12, dpi=150)

```

# Interpretation- Observations falling in the top-right quadrant represent “high-high” clusters. Statistically significant clusters - those with a p-value less than or equal to 0.05 - are colored red on the chart. The bottom-left quadrant also represents spatial clusters, but instead includes lower-pc1 tracts that are also surrounded by tracts with similarly low pc1. The top-left and bottom-right quadrants are home to the spatial outliers, where values are dissimilar from their neighbors.


# Cluster map using ggplot2 and geom_sf(). Here observations are visualized in relationship to their cluster membership and statistical significance
```{r}

ggplot(dfw_lisa_clusters, aes(fill = lisa_cluster)) + 
  geom_sf(size = 0.1) + 
  theme_void() + 
  scale_fill_manual(values = color_values) + 
  labs(fill = "Cluster type")

ggsave("ne_pc1_clusters_map.tiff",
          width = 12, height=12, dpi=150)

```


####################################################################################################################################
####################################################################################################################################

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor, stringr, zipcodeR, lubridate, tmap, sf, tigris)
```


```{r}
benign_neop_mass<- list(155000,159800,162800,162801,162802,162803,162804,171800,186000,186001,186002,186003,
186004,189000,189001,189002,189003,189004,190500,190501,190502,190503,190504,191000,
194000,202300,208000,214000,214001,214002,214003,214004,214100,214200,214300,214400,
214401,214402,214403,214404,214800,214810,214900, 216910,216920, 238000,238010,238020,238030,
238040,238080,239200,239201,239202,239203,239204)
#count 51
lymphatic_malf<- list(228000, 228010,228020,228030,228031,228032,228033,228034,228040,228090,
                      228100,228101,228102,228103,228104,453000, 457800)
#count 2,306
eye<- list(237700, 330100,331890,335000,345600,351000,352600,362600,
           362601,362602,362603,362604,362700,363200,363201,363202,
           363203,363204,368000,378000,379500,740000,740010,740020,
           740030,740080,740100,740200,740210,740290,741000,741010,
           741020,741030,741040,741050,741060,741070,741080,741085,
           741086,741087,741090,741900,741910,741920,741930,741940,
           741980,741985,741990,742000,742080,742085,742086,742090,
           742100,742200,742210,742220,742230,742235,742240,742250,
           742260,742270,742280,742290,742300,742310,742320,742380,
           742390,742400,742410,742411,742412,742413,742414,742420,
           742421,742422,742423,742424,742480,742481,742482,742483,
           742484,742485,742486,742500,742510,742520,742530,742540,
           742580,742800,742810,742880,742900,742910,742990,743000,
           743001,743002,743003,743004,743100,743101,743102,743103,
           743104,743200,743201,743202,743203,743204,743210,743211,
           743212,743213,743214,743220,743221,743222,743223,743224,
           743300,743301,743302,743303,743304,743310,743311,743312,
           743313,743314,743320,743321,743322,743323,743324,743325,
           743326,743330,743331,743332,743333,743334,743340,743341,
           743342,743343,743344,743380,743381,743382,743383,743384,
           743390,743391,743392,743393,743394,743400,743401,743402,
           743403,743404,743410,743411,743412,743413,743414,743420,
           743421,743422,743423,743424,743430,743431,743432,743433,
           743434,743440,743441,743442,743443,743444,743480,743481,
           743482,743483,743484,743490,743491,743492,743493,743494,
           743500,743501,743502,743503,743504,743510,743511,743512,
           743513,743514,743520,743521,743522,743523,743524,743530,
           743531,743532,743533,743534,743535,743580,743581,743582,
           743583,743584,743590,743591,743592,743593,743594,743600,
           743601,743602,743603,743604,743610,743611,743612,743613,
           743614,743620,743621,743622,743623,743624,743630,743631,
           743632,743633,743634,743635,743636,743640,743641,743642,
           743643,743644,743650,743660,743661,743662,743663,743664,
           743670,743671,743672,743673,743674,743800,743801,743802,
           743803,743804,743810,743811,743812,743813,743814,743900,
           743901,743902,743903,743904,744020,744021,744022,744023,
           744024,744030,744031,744032,744033,744034,744090,744091,
           744092,744093,744094,756100)
#count:99
endo<- list(243990,251200,252100,253280,253820,255200,257800,759100,759101,759102,
            759103,759104,759110,759111,759112,759113,759114,759120,759121,759122,
            759123,759124,759130,759131,759132,759133,759134,759180,759181,759182,
            759183,759184,759190,759191,759192,759193,759194,759200,759210,759230,
            759231,759232,759233,759234,759280,759290,759300)
#count 1,595
genetic<- list(270100,270200,270300,270600,270700,271000,272700,275330,277000,277010,277500,
               277510,277620,277630,279110,758000,758010,758020,758030,
               758040,758090,758100,758110,758120,758130,758190,758200,
               758210,758220,758230,758290,758295,758300,758310,758320,
               758330,758340,758350,758360,758370,758380,758390,758400,
               758500,758510,758520,758530,758540,758580,758585,758586,
               758590,758600,758610,758690,758700,758710,758790,758800,
               758810,758820,758830,758840,758850,758860,758880,
               758890,758900,758910,758920,758930,758990,759340,759500,
               759600,759610,759620,759630,759680,759690,759700)
#count 1,998
hepatic<- list(277400,453000,750280,750300,750310,750320,750325,750330,750340,750350,
               750380,750400,750410,750420,750430,750480,750500,750510,750580,750600,
               750700,750710,750720,750730,750740,750750,750780,750800,750900,750910,
               750920,750990,751000,751010,751100,751110,751120,751190,751195,751200,
               751210,751220,751230,751240,751300,751310,751320,751330,751340,751400,
               751410,751420,751490,751495,751500,751510,751520,751530,751540,751550,
               751555,751560,751580,751590,751600,751610,751620,751630,751640,751650,
               751660,751670,751680,751700,751710,751720,751730,751740,751780,751790,
               751800,751810,751820,751880,751900,777100,777600,778000)
#count: 2
immune<- list(279200,759240)
#count: 6
hematolo<- list(282000,282100,282200,282600,284000,286000,286400) 
#cardiac count: 5,969
cardiac<- list(425300, 426705,427900,745000,745010,745100,745110,745120,745130,745140,745150,
               745180,745190,745200,745210,745300,745400,745410,745420,745480,745485,745486,
               745487,745490,745500,745510,745520,745570,745580,745590,745600,745610,45620,
               745630,745680,745690,745700,745800,745900,746000,746010,746020,746080,746090,
               746100,746105,746106,746200,746300,746400,746470,746480,746490,746500,746505,
               746600,746700,746800,746810,746820,746830,746840,746850,746860,746870,746880,
               746881,746882,746883,746885,746886,746887,746900,746910,746920,746930,746990,
               746995,747000,747100,747110,747120,747190,747200,747210,747215,747216,747217,
               747220,747230,747240,747250,747260,747270,747280,747285,747290,747300,747301,
               747302,747303,747304,747310,747320,747321,747322,747323,747324,747325,747330,
               747340,747380,747381,747382,747383,747384,747390,747391,747392,747393,747394,
               747400,747410,747420,747430,747440,747450,747480,747490,747500,747600,747601,
               747602,747603,747604,747610,747611,747612,747613,747614,747620,747630,747640,
               747641,747642,747643,747644,747650,747680,747690,747800,747810,747880,747900)
#cranial count: 6,934
cranial<-list(520600,524000,524080,744000,744001,744002,744003,744004,744010,744011,744012,744013,
              744014,744100,744110,744120,744200,744201,744202,744203,744204,744210,744211,744212,
              744213,744214,744220,744230,744231,744232,744233,744234,744240,744241,744242,744243,
              744244,744245,744246,744250,744251,744252,744253,744254,744280,744281,744282,744283,
              744284,744300,744301,744302,744303,744304,744400,744401,744402,744403,744404,744410,
              744480,744481,744482,744483,744484,744500,744800,744810,744820,744830,744880,744881,
              744882,744883,744884,744900,744910,748000,748001,748002,748003,748004,748100,748101,
              748102,748103,748104,748110,748120,748121,748122,748123,748124,748130,748140,748180,
              748181,748182,748183,748184,748185,748190,750000,750100,750110,750120,750130,750140,
              750180,750190,750200,750210,750230,750240,750250,750260,750270,754000,754010,754020,
              754030,754040,754050,754051,754052,754053,754054,754055,754060,754070,754080,754090,
              754100,754101,754102,754103,754104,756000,756001,756002,756003,756004,756005,756006,
              756010,756011,756012,756013,756014,756020,756021,756022,756023,756024,756030,756040,
              756045,756046,756050,756055,756056,756057,756060,756065,756080,756085,756090,759800,
              759220,749000,749010,749020,749030,749040,749050,749060,749070,749080,749090,749100,
              749110,749120,749190,749200,749210,749220,749290)
#abdominal count: 365
abdominal<- list(550000,550001,550002,550003,550004,550100,550101,550102,550103,550104,550900,550901,
                 550902,550903,550904,553100,553200,756700,756710,756720,756790,756795)

#lung count: 1,327
lung<- list(748205,748206,748209,748300,748310,748330,748340,748341,748342,748343,748344,748350,
            748351,748352,748353,748354,748360,748380,748385,748390,748400,748401,748402,748403,
            748410,748411,748412,748413,748414,748420,748421,748422,748423,748424,748480,748481,
            748482,748483,748484,748500,748501,748502,748503,748504,748510,748511,748512,748513,
            748514,748520,748521,748522,748523,748524,748580,748581,748582,748583,748584,748590,
            748591,748592,748593,748594,748600,748601,748602,748603,748604,748610,748611,748612,
            748613,748614,748620,748621,748622,748623,748624,748625,748690,748691,748692,748693,
            748694,748800,748801,748802,748803,748804,748810,748880,748881,748882,748883,748884,
            748900,756600,756610,756615,756616,756617,756620,756621,756622,756623,756624,756680,
            756681,756682,756683,756684,756690,756691,756692,756693,756694)

#renal/genitourinary: 4,106
renal_genuri<-list(752000,752001,752002,752003,752004,752010,752011,752012,752013,752014,752020,752021,
                   752022,752023,752024,752080,752081,752082,752083,752084,752085,752090,752091,752092,
                   752093,752094,752100,752101,752102,752103,752104,752110,752120,752121,752122,752123,
                   752124,752190,752191,752192,752193,752194,752200,752300,752310,752320,752380,752390,
                   752400,752410,752420,752430,752440,752450,752460,752470,752480,752490,752500,752501,
                   752502,752514,752520,752530,752531,752532,752533,752534,752600,752605,752606,752607,
                   752610,752620,752621,752625,752626,752627,752700,752710,752720,752730,752790,752800,
                   752801,752802,752803,752804,752810,752811,752812,752813,752814,752820,752830,752831,
                   752832,752833,752834,752840,752850,752860,752865,752870,752880,752900,753000,753009,
                   753010,753011,753012,753013,753100,753101,753102,753103,753110,753111,753112,753113,
                   753114,753120,753121,753122,753123,753124,753130,753131,753132,753133,753134,753140,
                   753141,753142,753143,753144,753150,753151,753152,753153,753154,753160,753161,753162,
                   753163,753164,753180,753181,753182,753183,753184,753200,753201,753202,753203,753204,
                   753210,753211,753212,753213,753214,753220,753221,753222,753223,753224,753290,753291,
                   753292,753293,753294,753300,753301,753302,753303,753304,753310,753311,753312,753313,
                   753314,753320,753321,753322,753323,753324,753330,753331,753332,753333,753334,753340,
                   753341,753342,753343,753344,753350,753351,753352,753353,753354,753380,753381,753382,
                   753383,753384,753400,753401,753402,753403,753404,753410,753411,753412,753413,753414,
                   753420,753421,753422,753423,753424,753480,753481,753482,753483,753484,753485,753500,
                   753600,753610,753620,753630,753690,753700,753710,753790,753800,753810,753820,753830,
                   753840,753850,753860,753870,753880,753900,753901,753902,753903,753904,753910,753911,
                   753912,753913,753914,753920,753930,753990,778600)

#musculoskeletal count: 4,350
musc_ske<- list(755021,755022,755023,755024,755030,755031,755032,755033,755034,755090,755091,
                755092,755093,755094,755095,755096,755100,755101,755102,755103,755104,755110,
                755111,755112,755113,755114,755120,755121,755122,755123,755124,755130,755131,
                755132,755133,755134,755190,755193,755196,754200,754210,754220,754300,754301,
                754302,754303,754304,754310,754311,754312,754313,754314,754400,754401,754402,
                754403,754404,754410,754411,754412,754413,754414,754420,754421,754422,754423,
                754424,754430,754431,754432,754433,754434,754440,754441,754442,754443,754444,
                754490,754491,754492,754493,754494,754500,754501,754502,754503,754504,754510,
                754511,754512,754513,754514,754520,754530,754531,754532,754533,754534,754590,
                754591,754592,754593,754594,754600,754601,754602,754603,754604,754610,754611,
                754612,754613,754614,754615,754680,754681,754682,754683,754684,754690,754691,
                754692,754693,754694,754700,754701,754702,754703,754704,754720,754721,754722,
                754723,754724,754730,754731,754732,754733,754734,754735,754780,754781,754782,
                754783,754784,754800,754810,754820,754825,754830,754831,754832,754833,754834,
                754840,754841,754842,754843,754844,754850,754851,754852,754853,754854,754880,
                754881,754882,754883,754884,755200,755201,755202,755203,755204,755210,755211,
                755212,755213,755214,755220,755221,755222,755223,755224,755230,755231,755232,
                755233,755234,755240,755241,755242,755243,755244,755250,755251,755252,755253,
                755254,755260,755261,755262,755263,755264,755265,755270,755271,755272,755273,
                755274,755280,755281,755282,755283,755284,755285,755290,755291,755292,755293,
                755294,755300,755301,755302,755303,755304,755310,755311,755312,755313,755314,
                755320,755321,755322,755323,755324,755330,755331,755332,755333,755334,755340,
                755341,755342,755343,755344,755350,755351,755352,755353,755354,755360,755361,
                755362,755363,755364,755365,755366,755380,755381,755382,755383,755384,755385,
                755390,755391,755392,755393,755394,755400,755401,755402,755403,755404,755410,
                755411,755412,755413,755414,755420,755421,755422,755423,755424,755430,755431,
                755432,755433,755434,755440,755441,755442,755443,755444,755480,755481,755482,
                755483,755484,755490,755491,755492,755493,755494,755500,755501,755502,755503,
                755504,755510,755511,755512,755513,755514,755520,755521,755522,755523,755524,
                755525,755526,755530,755531,755532,755533,755534,755535,755536,755540,755541,
                755542,755543,755544,755550,755551,755552,755553,755554,755555,755556,755560,
                755561,755562,755563,755564,755580,755581,755582,755583,755584,755585,755590,
                755591,755592,755593,755594,755600,755601,755602,755603,755604,755605,755606,
                755610,755611,755612,755613,755614,755616,755620,755621,755622,755623,755624,
                755630,755631,755632,755633,755634,755640,755641,755642,755643,755644,755645,
                755646,755647,755650,755651,755652,755653,755654,755660,755661,755662,755663,
                755664,755665,755670,755680,755681,755682,755683,755684,755685,755690,755691,
                755692,755693,755694,755800,755810,755880,755900,756110,756120,756130,756140,
                756145,756146,756150,756155,756156,756160,756165,756166,756170,756175,756179,
                756180,756185,756190,756200,756300,756301,756302,756303,756304,756310,756311,
                756312,756313,756314,756320,756321,756322,756323,756324,756330,756331,756332,
                756333,756334,756340,756341,756342,756343,756344,756350,756360,756380,756390,
                756400,756410,756420,756430,756445,756446,756447,756450,756460,756470,756480,
                756490,756500,756505,756506,756510,756520,756525,756530,756540,756550,756560,
                756570,756575,756580,756590,756800,756801,756802,756803,756804,756810,756811,
                756812,756813,756814,756820,756821,756822,756823,756824,756830,756840,756850,
                756860,756861,756862,756863,756864,756880,756900,756910,756920,756930,756940,
                756990,759820,759840,759860,759870)

#skin and soft tissue: 1,602
skin_soft_tiss<- list(685100,757000,757001,757002,757003,757004,757100,757110,757115,757120,
                      757190,757195,757196,757197,757200,757300,757310,757320,757330,757340,
                      757345,757346,757350,757360,757370,757380,757390,757395,757400,757410,
                      757420,757430,757450,757480,757500,757501,757502,757503,757504,757510,
                      757511,757512,757513,757514,757515,757516,757520,757530,757540,757541,
                      757542,757543,757544,757580,757585,757600,757601,757602,757603,757604,
                      757610,757611,757612,757613,757614,757620,757621,757622,757623,757624,
                      757630,757631,757632,757633,757634,757640,757641,757642,757643,757644,
                      757650,757680,757681,757682,757683,757684,757800,757900,757910,757920,
                      757990)

#other count: 470
other<- list(658800,759000,759005,759010,759020,759030,759040,759041,759042,759043,759044,
             759050,759051,759052,759053,759054,759080,759090,759310,759320,759330,759390,
             759400,759410,759420,759430,759440,759480,759490,759890,759900,759910,759990,
             999999)
#unlikely: 30
unlike<- list(608200,608201,608202,608203,608204,760710,760750,767600,771000,771090,771100,
              771210,771220,771230,771280,774480,774490,90000)

```

===============================================================================
===============================================================================

```{r}
data_bd <- read_csv("birth_def_v1.csv") |>
  mutate(city = str_trim(city)) |>
  mutate(city = str_to_title(city))

# Create a list of objects to filter by
filter_list <- list(pulmonary = lung, cardiac = cardiac, hepatic = hepatic,
                    skin_soft_tiss=skin_soft_tiss, musc_ske=musc_ske,
                    renal_genuri=renal_genuri, abdominal=abdominal,
                    cranial=cranial, hematolo=hematolo,immune=immune,
                    genetic=genetic, endocrine=endo, ophthal=eye,
                    lymphatic=lymphatic_malf, benign_neop_mass=benign_neop_mass)

# Use map() function to apply filter_all() to each object in filter_list
dt_list <- map(filter_list, ~ data_bd |> filter_all(any_vars(. %in% .x)))

# Rename the list elements to include "dat_"
names(dt_list) <- paste0("dat_", names(dt_list))

# Save each data frame to its own object in the global environment
list2env(dt_list, envir = .GlobalEnv)
```


```{r}
# Find all objects in the global environment that start with "dat_"
dt_names <- ls(pattern = "^dat_")

# Combine all data frames into a single data frame
```


```{r}
dt_combined <- bind_rows(mget(dt_names), .id = "df_name")

# Extract the dataframe name followed by "_" and add a new variable "class"
dt_combined <- dt_combined %>% 
  mutate(class = gsub("^dat_(.*)", "\\1", df_name))

write_csv(dt_combined, "birth_defects_v2.csv")
```

#Reference zip-code file
```{r}
zip_dat<- zipcodeR::search_state("NE") |> select(c(1,3,6)) |>
  rename(zip9= "zipcode") |>
  mutate(zip9=as.factor(zip9))

birth_defects<- birth_defects |> left_join(zip_dat, by="zip9")
write_csv(birth_defects, "birth_defects_v2.csv")

dt_combined<- read_csv("birth_defects_v2.csv") |>
  filter(is.na(dth_cert)) |>
  group_by(bth_cert, case, bwt_gm, sexc, fac, city) |>
  filter(n() == 1)

write_csv(dt_combined, "birth_defects_v3.csv")
```
#==============================================================================#
#==============================================================================#
#==============================================================================#
#adding county infomation to the birth defects dataset
```{r}
dt_bd<- read_csv("birth_defects_v3.csv")
dt_bd$zip9 <- as.factor(dt_bd$zip9)

zip_dat<- zipcodeR::search_state("NE") |> select(c(1,3,6)) |>
  rename(zip9= "zipcode") |>
  mutate(zip9=as.factor(zip9))

#birth defects 
dt_bd_v4 <- dt_bd |> left_join(zip_dat, by="zip9")

#use nebraska zipcodes to drop any bd observations not from nebraska
filtered_dt_bd_v4 <- dt_bd_v4 %>%
  semi_join(lb, by = "county")

#final birth defects dataset for any individual level analysis
write_csv(filtered_dt_bd_v4, "birth_defects_v4.csv")

#use the same dt_db_v4 for generating the county level counts of birth defects
bd_county<- filtered_dt_bd_v4 |>
  select(c(63,65)) |>
  group_by(county, class) |>
  summarise(observations = n()) |>
  pivot_wider(names_from = class, values_from = observations) |>
  mutate(total_bd = sum(c_across(where(is.numeric)), na.rm = TRUE))

#final birth defects dataset for any county level analysis
write_csv(bd_county, "birth_defects_county.csv") 

```


#adding county information to live births data
```{r}
live_birth <- read_csv("live_birth_ne.csv")|>
  clean_names() |>
  rename(zip9= "mother_resident_zip") |>
  mutate(zip9=as.factor(zip9)) |>
  filter(mother_resident_state == "Nebraska")


zip_dat<- zipcodeR::search_state("NE") |> select(c(1,3,6)) |>
  rename(zip9= "zipcode") |>
  mutate(zip9=as.factor(zip9))

live_birth<- live_birth |> left_join(zip_dat, by="zip9") |>
  drop_na()
write_csv(live_birth, "live_birth_v1.csv")

#### aggregating live births
lb<- read_csv("live_birth_v1.csv") |>
  select(c(6)) |>
  count(county)

write_csv(lb, "live_birth_v2.csv")
```

##############################################################################
#combine live birth and birth defect counts per county
```{r}
bd<- read_csv("birth_defects_county.csv")
lb<- read_csv("live_birth_v2.csv")

bd_county_dat<- lb |>
  left_join(bd, by= "county") |>
  rename(live_birth= "n")


write_csv(bd_county_dat, "bd_cnty_v7.csv")
```


# Birth defects prevalence rate
```{r}

bd_prev_dat <- read_csv("bd_cnty_v7.csv") |>
  mutate(across(where(is.integer), as.numeric)) |>
  mutate(across(3:17, ~ . / live_birth)*100000)

write_csv(bd_prev_dat, "bd_prev_v8.csv")
```


# joining birth defects_live birth data with NE counties shapefile 
```{r}
bd_dt <- read_csv("bd_prev_v8.csv")

ne_counties <- bd_dt |>
  counties(state = "ne", cb = FALSE, resolution = "500k", year = "2010", class = "sf") |>
  clean_names()

#join birth defects_live birth data with ne county shapefile
bd_live_ne_map<- bd_dt %>%
 left_join(ne_counties, by = c("county" = "namelsad10"))

write_csv(bd_live_ne_map, "bd_cnty_v9.csv")

```


# barplots by birth defect types
```{r}
dat_bd_plt<- read_csv("bd_cnty_v9.csv")  |>
  select(-c(2,18:36))|>
  pivot_longer(cols = -c(county),
               names_to = "bd_type", values_to = "bd_rate") |>
  mutate(bd_type_lable= substr(bd_type, 1, 5))

ggplot(dat_bd_plt, aes(x = bd_rate, y = county)) +
  geom_bar(stat = "identity") +
  labs(title = "", x = "", y = "") +
  theme_minimal()+
  facet_grid(.~bd_type_lable, scales = "free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# Map birth defects
```{r}
bd_dt <- read_csv("bd_prev_v8.csv")

ne_counties <- bd_dt %>%
  counties(state = "ne", cb = FALSE, resolution = "500k", year = "2010", class = "sf") %>%
  clean_names()

bd_live_ne_map <- bd_dt %>%
  left_join(ne_counties, by = c("county" = "namelsad10")) %>%
  st_as_sf()  # Convert to sf class

w <- tm_shape(bd_live_ne_map) +
  tm_polygons(col = "cardiac",
              breaks = quantile(bd_live_ne_map$cardiac, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE),
              legend.is.portrait = TRUE,
              palette = "viridis",
              title = "Cardiac defects per 100k children") +
  tm_borders() +
   tm_text(text = "county", size= 0.6) +
  tm_borders(col = "blue", lwd = 2, alpha = 0.5)+
    tm_compass(position = c("right", "top"))

tmap_save(w,"ne_cardiacdefect_viridis_palette.tiff",
          width = 12, height = 15, dpi = 150)

```

#Summary table for manuscript
```{r}
# 1. Categorize gestation age; read birth_def_v1.csv
data_bd <- data_bd %>%
  mutate(gest_category = if_else(gest < 37, "<37", ">=37"))

# Get the frequency of each category; <37= 5111 & >=37 = 19,854
gest_freq <- data_bd %>%
  group_by(gest_category) %>%
  summarise(frequency = n())

# 2. Categorize birth weight
data_bd <- data_bd %>%
  mutate(bw_category = if_else(bwt_gm <2500, "<2500", ">=2500"))

# Get the frequency of each birth weight category; <2500 =5062  & >=2500 = 19901 and NA = 2
bw_freq <- data_bd %>%
  group_by(bw_category) %>%
  summarise(frequency = n())

# 3. Categorize birth year
data_bd <- data_bd %>%
  mutate(byr_category = if_else(bth_yr <2010, "<2010", ">=2010"))

# Get the frequency of each birth weight category; <2010= 16,891  & >=2010= 8074  
byr_freq <- data_bd %>%
  group_by(byr_category) %>%
  summarise(frequency = n())

# 4. Categorize maternal age
data_bd <- data_bd %>%
  mutate(mage_category = if_else(mage <35, "<35", ">=35"))

# Get the frequency of each birth weight category; <35= 21474 & >=35= 3486, NA = 5
mage_freq <- data_bd %>%
  group_by(mage_category) %>%
  summarise(frequency = n())

# 5. Get the frequency of each value in the hispm variable; 1= 1460, 2= 42, 5 = 1318, 6= 22106 (Refer natality code in dissertation data onedrive folder)
hispm_freq <- data_bd %>%
  count(hispm) %>%
  filter(hispm >= 1 & hispm <= 6)

# 6. Get the frequency of each value in the mrace variable; 0 = 1877; 1= 20707; 2=1578; 3= 247; 4= 32; 5= 18; 6= 5; 7= 28; 8= 450; 9= 23;
#9 categories: American Indian or Alaska Native; Black; Chinese; Filipino; Guamanian; Hawaiian (includes part-Hawaiian); Japanese; Other Asian; White.
mrace_freq <- data_bd %>%
  count(mrace) %>%
  filter(mrace >= 0 & mrace <= 9)

#7. Get the frequency of each value in the sexc variable/infant gender; F= 10298; M= 14666
sexc_freq <- data_bd %>%
  count(sexc)

#8. Get the frequency of each value in the diabetes variable; Y= 1151; N= 23763; Unknown= 51
diabetes_freq <- data_bd %>%
  count(diabetes)

#9. Get the frequency of each value in the tobacco variable; Y= 4328; N= 20615; Unknown= 22
tobacco_freq <- data_bd %>%
  count(tobacco)

```


#SDOH_pediatric_cancer_birth_defects
```{r}
#get list of variables from 2010-2014 census
acs_variable_list<- load_variables(2014, "acs5", cache = T)
ped_pop<- get_acs(geography = "county",
                  state = "NE",
                  year=2014,
                  survey = "acs5",
                  variables=c(mg1_pop= "B01001_003",mg2_pop= "B01001_004",mg3_pop= "B01001_005",mg4_pop= "B01001_006",mg5_pop= "B01001_007",
                              fg1_pop= "B01001A_018",fg2_pop= "B01001A_019",fg3_pop= "B01001A_020",fg4_pop= "B01001A_021",fg5_pop= "B01001A_022",
                              mg1_blk_pop= "B01001B_003",mg2_blk_pop= "B01001B_004",mg3_blk_pop= "B01001B_005",mg4_blk_pop= "B01001B_006",mg5_blk_pop= "B01001B_007",
                              fg1_blk_pop= "B01001B_018",fg2_blk_pop= "B01001B_019",fg3_blk_pop= "B01001B_020",fg4_blk_pop= "B01001B_021",fg5_blk_pop= "B01001B_022",
                              mg1_hisp_pop= "B01001I_003",mg2_hisp_pop= "B01001I_004",mg3_hisp_pop= "B01001I_005",mg4_hisp_pop= "B01001I_006",mg5_hisp_pop= "B01001I_007",
                              fg1_hisp_pop= "B01001I_018",fg2_hisp_pop= "B01001I_019",fg3_hisp_pop= "B01001I_020",fg4_hisp_pop= "B01001I_021",fg5_hisp_pop= "B01001I_022",
                              ssi_snap="B22002_003",
                              no_hel_ins_mu6="B27001_005",no_hel_ins_m6_18="B27001_008",
                              no_hel_ins_fu6="B27001_033",no_hel_ins_f6_18="B27001_036",
                              foregin_born="B06012_013",
                              poverty_100="B06012_002",
                              sing_prnt_u6="B05009_013", sing_prnt_6_17="B05009_031",
                              un_empl="B23007_013",
                              education="B16010_002",
                              langu="B06007_008",
                              no_vehic="B08201_002",
                              median_incom="B10010_001",
                              hous_w_pedpop="B11005_002",hous_wo_pedpop="B11005_011"
                              ),
                  geometry = T,
                  output = "wide") %>% clean_names()

```


```{r}
#Total population
ped_pop$m_pop <- as.numeric(ped_pop$mg1_pop_e+ ped_pop$mg2_pop_e+ ped_pop$mg3_pop_e+
                              ped_pop$mg4_pop_e+ped_pop$mg5_pop_e)
ped_pop$f_pop <- as.numeric(ped_pop$fg1_pop_e+ ped_pop$fg2_pop_e+ ped_pop$fg3_pop_e+
                              ped_pop$fg4_pop_e+ped_pop$fg5_pop_e)

```


```{r}
#Total households
ped_pop$households<-as.numeric(ped_pop$hous_w_pedpop_e+ped_pop$hous_wo_pedpop_e)
#Population by race
ped_pop$m_blk_pop<-as.numeric(ped_pop$mg1_blk_pop_e+ped_pop$mg2_blk_pop_e+ped_pop$mg3_blk_pop_e+
                                ped_pop$mg4_blk_pop_e+ped_pop$mg5_blk_pop_e)
ped_pop$f_blk_pop<-as.numeric(ped_pop$fg1_blk_pop_e+ped_pop$fg2_blk_pop_e+ped_pop$fg3_blk_pop_e+
                                ped_pop$fg4_blk_pop_e+ped_pop$fg5_blk_pop_e)
ped_pop$m_hisp_pop<- as.numeric(ped_pop$mg1_hisp_pop_e+ped_pop$mg2_hisp_pop_e+ped_pop$mg3_hisp_pop_e+
                                  ped_pop$mg4_hisp_pop_e+ped_pop$mg5_hisp_pop_e)
ped_pop$f_hisp_pop<- as.numeric(ped_pop$fg1_hisp_pop_e+ped_pop$fg2_hisp_pop_e+ped_pop$fg3_hisp_pop_e+
                                  ped_pop$fg4_hisp_pop_e+ped_pop$fg5_hisp_pop_e)


#health insurance
ped_pop$m_ins_cnt<-as.numeric(ped_pop$no_hel_ins_mu6e+ped_pop$no_hel_ins_m6_18e)
ped_pop$f_ins_cnt<-as.numeric(ped_pop$no_hel_ins_fu6e+ped_pop$no_hel_ins_f6_18e)

#single parent
ped_pop$sing_prnt_cnt<- as.numeric(ped_pop$sing_prnt_u6e+ped_pop$sing_prnt_6_17e)

write.csv(ped_pop,"cenus_api_extract.csv")
```


```{r}
#START here
dat<- ped_pop[c(1,2,64,73,75,81,83,85,87,95:105)]

#calculating percentages - Exclusive to pediatric population
dat$m_blk_pct<- as.numeric((dat$m_blk_pop/dat$m_pop)*100)
dat$f_blk_pct<- as.numeric((dat$f_blk_pop/dat$f_pop)*100)
dat$m_hisp_pct<- as.numeric((dat$m_hisp_pop/dat$m_pop)*100)
dat$f_hisp_pct<- as.numeric((dat$f_hisp_pop/dat$f_pop)*100)
dat$m_heal_ins_pct<- as.numeric((dat$m_ins_cnt/dat$m_pop)*100)
dat$f_heal_ins_pct<- as.numeric((dat$f_ins_cnt/dat$f_pop)*100)
dat$sing_pent_pct <- as.numeric(dat$sing_prnt_cnt/(dat$m_pop+dat$f_pop)*100)
dat$ssi_snap_pct<- as.numeric((dat$ssi_snap_m/dat$households)*100)
dat$vehicle_pct<- as.numeric((dat$no_vehic_e/dat$households)*100)
#
write.csv(dat, "ped_sdohProcessed.csv")

# save same file in rda format as backup
save(dat, file = "ped_sdohProcessed.RDA")
```

```{r}
load("ped_sdohProcessed.RDA")
```

#removing geometry variable (as_tibble) and saving count variables separately for stratified analysis
```{r}
sdh <- dat |>
  as_tibble()|>
  select(c(1,11:20)) |>
  rename(geoid10= "geoid")

#
sdh$geoid10 <- as.numeric(sdh$geoid10)

#
write.csv(sdh, "ped_sdohcount.csv")

# save same file in rda format as backup
save(sdh, file = "ped_sdohcount.RDA")
```

######################################################################################################################################
#######################################################################################################################################

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor, stringr, zipcodeR, lubridate, tmap, sf, tigris)
```

#Join birth defects data with NE counties shapefile and pesticide data
```{r}

dat_bd <- read_csv("bd_cnty_v7.csv") |>
   rename(namelsad10 ="county") 

ne_counties <- counties(state = "ne", cb = FALSE, resolution = "500k", year = "2010", class="sf") |>
  clean_names()

# Joining birth defects with ne counties shape file
dat <- dat_bd |>
  left_join(ne_counties, by = "namelsad10") |>
  select(c(1:17,21,35))

# reading Nebraska chemicals data
dat_chem <- read_csv("ne_final_chem_widev5.csv") |>
  rename(countyfp= "county_fips_code") |>
  mutate(countyfp = str_pad(as.character(countyfp), width = 3, pad = "0"))

#joining chemicals with birth defects data
chem_bd <- dat|>
  left_join(dat_chem, by ="countyfp")

# save birth defects and chemical file
write_csv(chem_bd, "birth_def_chem.csv")

#RDA format
save(chem_bd, file = "birth_def_chem.RDA")

# Join SDOH and birth defects_chemicals data

dat_svi <- load("ped_sdohProcessed.RDA") 
sdoh <- dat |>
  rename(geoid10= "geoid") 

bd_chem_sdoh <- chem_bd |>
left_join(sdoh, by = "geoid10")

# save final birth defects, chemicals and sdoh data
write_csv(bd_chem_sdoh, "birth_def_chem_sdoh.csv")

#RDA format
save(bd_chem_sdoh, file = "birth_def_chem_sdoh.RDA")
```


#######################################################################################################################################
######################################################################################################################################


# Mixture analysis using generalized weighted quantile sum regression model

```{r}
library(pacman)
pacman::p_load(tidyverse, dplyr, janitor,gWQS)
```

#sdoh data
```{r}
#join variables: geoid10 and county name
load("ped_sdohProcessed.RDA") |> as_tibble()

sdoh <- dat |>
  as_tibble() |>
  rename(geoid10= "geoid") |>
  select(-c(3:20)) |>
  mutate_at(vars(3:11), ~ round(., 2)) |>
  mutate(name = str_split_fixed(name, ", ", 2)[, 1])|>
  rename(county= "name")

rm(dat)
```

#pediatric population
```{r}
ped_pln<- read_csv("ped_popln_exp.csv") 
```

#pediatric cancer data
```{r}
ped_can_count<- read_csv("ped_cancer_v3.csv") |>
  select(c(1:13))
```

#join sdoh with outcomes
```{r}
sdoh_outcms <- sdoh |>
  full_join(ped_can_count, by = "county") |>
  full_join(ped_pln, by = "county") |>
  full_join(bd_count, by = "county") |>
  clean_names()

```

#chemical data
```{r}
ne_chem<- read_csv("ne_final_chem_widev5.csv") |>
  rename(geoid10= "county_fips_code") |>
  mutate(geoid10 = str_pad(as.character(geoid10), width = 3, pad = "0"),
         geoid10 = paste0("31", geoid10))

```


# join chemicals, sdoh (percentage variables) and outcomes into a file
```{r}
fin_dat<- full_join(ne_chem, sdoh_outcms, by= "geoid10") |>
  select(-c("geoid")) |>
  mutate_at(vars(44:72), ~ replace_na(., 0))

write_csv(fin_dat, "final_dissrt_analy_data.csv")
```

# join sdoh count data to the final_dissrt_analy_data for stratified analysis purpose

```{r}
dat1 <- read_csv("final_dissrt_analy_data.csv")
dat2 <- read_csv("ped_sdohcount.csv")
 
# 
dat2 <- dat2 |>
  select(-contains("...1"))

#
fin_dat1 <- full_join(dat1, dat2, by= "geoid10") |>
  mutate_at(vars(73:82), ~ replace_na(., 0))

write_csv(fin_dat1, "final_dissrt_analy_sdh_count_datav1.csv")

 # Save same file as RDA 
save(fin_dat1, file = "final_dissrt_analy_sdh_count_datav1.RDA")
```

#############################################################################
```{r}
pacman::p_load(tidyverse, janitor, gWQS)
```

# using data without sdoh counts
```{r}
dat<- read_csv("final_dissrt_analy_data.csv")
```

#gWQS model
```{r, warning=FALSE}
chem_mix<- names(dat)[2:33]

wqs_res<- gwqs(ophthal ~ wqs+ m_blk_pct + f_blk_pct + m_hisp_pct + f_hisp_pct + m_heal_ins_pct + 
                 f_heal_ins_pct +vehicle_pct + sing_pent_pct + ssi_snap_pct, 
               mix_name = chem_mix, 
               offset= dat$live_birth,
               zero_infl = FALSE, #only for cancer sub-types
               data = dat,
               q=10, validation= 0.6, b = 10, 
               b1_pos = TRUE, b1_constr = FALSE, 
               family= "negbin", 
               seed = 2023)
```

```{r}
gwqs_scatterplot(wqs_res)
gwqs_summary_tab(wqs_res)

gwqs_barplot(wqs_res)
gwqs_weights_tab(wqs_res)
```

#repeated holdout # try to use rs- subset term
```{r, warning=FALSE}
wqs_res_rh <- gwqsrh(cardiac ~ wqs+
                       #Below are list of covariates included
                       m_blk_pct + f_blk_pct + m_hisp_pct + f_hisp_pct + m_heal_ins_pct +
                       f_heal_ins_pct +vehicle_pct + sing_pent_pct + ssi_snap_pct, 
                     ###################
                     mix_name = chem_mix, #list of pesticides as mixture
                     ###################
                     offset=dat$live_birth, #offset variable to yield rat
                     ###################
                     zero_infl = FALSE, #only for sub-types
                     ###################
                     data = dat, #input dataset
                     ###################
                     q=10, #Converting pesticides to quantile scale
                     ###################
                     validation= 0.6, #split 60% data for validation
                     ###################
                     b = 10, #considering 100 bootstrap samples
                     ###################
                     b1_pos = TRUE, #assuming beta as positive
                     ###################
                     b1_constr = FALSE, #Unconstrained beta direction
                     ###################
                     family= "negbin", # assuming outcome following negative binomial distribution
                     ###################
                     seed = 2023, #seed to reproduce the same test and training data
                     ###################
                     rh=5 #repeated holdouts
                     ###################
                     )
```

```{r}
gwqs_summary_tab(wqs_res_rh)
gwqsrh_boxplot(wqs_res_rh, tau = 0)
gwqs_weights_tab(wqs_res_rh)

#ggsave("gwqsrh_abdominal_bd.tiff", 
       #width = 6,height = 9,
       #dpi=300)
```

#loop function
```{r}
gwqs_loop <- function(input_df, output_folder, outcomes, covariates=NULL, 
                      chem_mix) {
  # Loop through the list of outcomes
  for (outcome in outcomes) {
    # Construct the formula with specified covariates
    formula <- paste(outcome, "~ wqs ", covariates)
    
    # Create the file names based on the outcome and model type
    filename_prefix <- "model_output"
    file_name_wqs <- paste0("nrh", "_", outcome, ".rda")
    file_name_wqs_rh <- paste0("rh", "_", outcome, ".rda")
    
    # Perform the first model (gWQS)
    wqs_res <- tryCatch(
      gwqs(as.formula(formula), mix_name = chem_mix, offset = dat$ped_popln,
           zero_infl = FALSE, data = input_df, q = 10, validation = 0.6, b = 10,
           b1_pos = TRUE, b1_constr = FALSE, family = "negbin", seed = 2023),
      error = function(e) {
        cat(paste("Error occurred for outcome:", outcome, "\n", "Error message:", e$message, "\n"))
        return(NULL)
      }
    )
    
    if (is.null(wqs_res)) {
      next  # Move to the next outcome variable
    } else {
      # Save the first model output to RDA file
      save(wqs_res, file = file.path(output_folder, file_name_wqs))
    }
    
    # Perform the second model (gWQSRH)
    wqs_res_rh <- tryCatch(
      gwqsrh(as.formula(formula), mix_name = chem_mix, offset = dat$ped_popln,
             zero_infl = FALSE, data = input_df, q = 10, validation = 0.6, b = 100,
             b1_pos = TRUE, b1_constr = FALSE, family = "negbin", seed = 2023, rh = 5),
      error = function(e) {
        cat(paste("Error occurred for outcome:", outcome, "\n", "Error message:", e$message, "\n"))
        return(NULL)
      }
    )
    
    if (is.null(wqs_res_rh)) {
      next  # Move to the next outcome variable
    } else {
      # Save the second model output to RDA file
      save(wqs_res_rh, file = file.path(output_folder, file_name_wqs_rh))
    }
  }
}


```

#run function
```{r, warning=FALSE}

gwqs_loop(input_df = dat,
          output_folder = "~/Dissertation/test", 
          outcomes = names(dat)[44:55],  #update location of outcomes
          covariates = "+ m_blk_pct + f_blk_pct + m_hisp_pct + f_hisp_pct + m_heal_ins_pct + f_heal_ins_pct +vehicle_pct + sing_pent_pct + ssi_snap_pct ",
          chem_mix = names(dat)[2:33])
```

# for each type select load the specific Rda file
```{r}
load("~/Dissertation/test/nrh_total_can.rda") 

summary(wqs_res)
gwqs_barplot(wqs_res)

```


```{r}
load("~/Dissertation/test/rh_leukemia.rda") 

summary(wqs_res_rh)
gwqsrh_boxplot(wqs_res_rh)
gwqs_weights_tab(wqs_res_rh)

#
ggsave("gwqsrh_leukemia.tiff", 
       width = 6,height = 9,
       dpi=300)
```



